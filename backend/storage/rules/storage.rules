rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // =============================================================================
    // HELPER FUNCTIONS
    // =============================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Validate file size based on user role and file type
    function isValidFileSize() {
      return request.resource.size >= 1024 && 
             ((isAdmin() && request.resource.size <= 500 * 1024 * 1024) ||
              (isSpecialist() && request.resource.size <= 100 * 1024 * 1024) ||
              (isAttendee() && request.resource.size <= 10 * 1024 * 1024));
    }
    
    // Validate large file size for videos
    function isValidVideoFileSize() {
      return request.resource.size >= 1024 && 
             ((isAdmin() && request.resource.size <= 500 * 1024 * 1024) ||
              (isSpecialist() && request.resource.size <= 200 * 1024 * 1024) ||
              (isAttendee() && request.resource.size <= 50 * 1024 * 1024));
    }
    
    // Check if content type is allowed for images
    function isValidImageType() {
      return request.resource.contentType.matches('image/(png|jpg|jpeg|gif|webp)');
    }
    
    // Check if content type is allowed for documents
    function isValidDocumentType() {
      return request.resource.contentType.matches('application/(pdf|msword|vnd.openxmlformats-officedocument.wordprocessingml.document|vnd.ms-powerpoint|vnd.openxmlformats-officedocument.presentationml.presentation)') ||
             request.resource.contentType.matches('text/(plain|csv)');
    }
    
    // Check if content type is allowed for videos
    function isValidVideoType() {
      return request.resource.contentType.matches('video/(mp4|avi|mov|wmv|webm)');
    }
    
    // =============================================================================
    // USER PROFILE IMAGES
    // =============================================================================
    
    match /users/{userId}/profile/{imageId} {
      // Users can read and write their own profile images
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // Validate upload
      allow write: if isAuthenticated() 
        && request.auth.uid == userId
        && isValidImageType()
        && request.resource.size <= 5 * 1024 * 1024;
      
      // All authenticated users can read profile images
      allow read: if isAuthenticated();
    }
    
    // =============================================================================
    // DOCUMENT FILES WITH VERSION CONTROL
    // =============================================================================
    
    // Document structure: /documents/{category}/{documentId}/{version}/{fileName}
    match /documents/{category}/{documentId}/{version}/{fileName} {
      // Allow authenticated users to read and write documents
      allow read, write, delete: if isAuthenticated();
    }
    
    // Document thumbnails: /documents/{category}/{documentId}/thumbnails/{fileName}
    match /documents/{category}/{documentId}/thumbnails/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidImageType() && 
        request.resource.size <= 5 * 1024 * 1024; // 5MB for thumbnails
      allow delete: if isAuthenticated();
    }
    
    // Document previews: /documents/{category}/{documentId}/previews/{fileName}
    match /documents/{category}/{documentId}/previews/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
        (isValidImageType() || request.resource.contentType == 'application/pdf') &&
        request.resource.size <= 20 * 1024 * 1024; // 20MB for previews
      allow delete: if isAuthenticated();
    }
    
    // =============================================================================
    // FORUM POST ATTACHMENTS
    // =============================================================================
    
    match /forum/posts/{postId}/attachments/{fileName} {
      // All authenticated users can read attachments
      allow read: if isAuthenticated();
      
      // Users can upload attachments to their posts
      allow write: if isAuthenticated()
        && (isValidImageType() || isValidDocumentType())
        && isValidFileSize();
      
      // Authenticated users can delete attachments (app handles permissions)
      allow delete: if isAuthenticated();
    }
    
    // =============================================================================
    // FORUM REPLY ATTACHMENTS
    // =============================================================================
    
    match /forum/replies/{replyId}/attachments/{fileName} {
      // All authenticated users can read attachments
      allow read: if isAuthenticated();
      
      // Users can upload attachments to their replies
      allow write: if isAuthenticated()
        && (isValidImageType() || isValidDocumentType())
        && isValidFileSize();
      
      // Authenticated users can delete attachments (app handles permissions)
      allow delete: if isAuthenticated();
    }
    
    // =============================================================================
    // IMPACT METRICS ATTACHMENTS
    // =============================================================================
    
    match /impact-metrics/{userId}/submissions/{submissionId}/{fileName} {
      // Users can read their own impact metric attachments
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can upload attachments to their own impact metrics
      allow write: if isAuthenticated() 
        && request.auth.uid == userId
        && (isValidImageType() || isValidDocumentType())
        && isValidFileSize();
      
      // Authenticated users can read submissions (app handles permissions)
      allow read: if isAuthenticated();
      
      // Authenticated users can delete attachments (app handles permissions)
      allow delete: if isAuthenticated();
    }
    
    // =============================================================================
    // TEMPORARY UPLOADS
    // =============================================================================
    
    match /temp/{userId}/{uploadId} {
      // Users can manage their own temporary uploads
      allow read, write, delete: if isAuthenticated() && request.auth.uid == userId;
      
      // Validate temporary upload
      allow write: if isAuthenticated() 
        && request.auth.uid == userId
        && (isValidImageType() || isValidDocumentType() || isValidVideoType())
        && isValidVideoFileSize();
    }
    
    // =============================================================================
    // SYSTEM ASSETS
    // =============================================================================
    
    match /system/{assetPath=**} {
      // All authenticated users can read system assets (logos, templates, etc.)
      allow read: if isAuthenticated();
      
      // Authenticated users can manage system assets (app handles permissions)
      allow write, delete: if isAuthenticated();
    }
    
    // =============================================================================
    // TEST FILES (Development Only)
    // =============================================================================
    
    match /test/{userId}/{fileName} {
      // Users can test storage functionality with their own test files
      allow read, write, delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // =============================================================================
    // EMAIL ATTACHMENTS
    // =============================================================================
    
    match /email/attachments/{templateId}/{fileName} {
      // Authenticated users can manage email attachments (app handles permissions)
      allow read, write, delete: if isAuthenticated();
      
      // Validate email attachments
      allow write: if isAuthenticated()
        && (isValidImageType() || isValidDocumentType())
        && isValidFileSize();
    }
    
    // =============================================================================
    // BACKUP FILES
    // =============================================================================
    
    match /backups/{backupId}/{fileName} {
      // Authenticated users can access backup files (app handles permissions)
      allow read, write, delete: if isAuthenticated();
    }
    
    // =============================================================================
    // TEMPORARY TESTING RULE - ALLOWS ALL AUTHENTICATED USERS
    // =============================================================================
    
    // Temporary: Allow all authenticated users (for testing)
    match /{allPaths=**} {
      allow read, write, delete: if isAuthenticated();
    }
  }
}